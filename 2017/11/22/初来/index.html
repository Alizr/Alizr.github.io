<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="linux/python/GTD/PKM"><title>初来 | li</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">初来</h1><a id="logo" href="/.">li</a><p class="description">只有永不遏制的奋斗,才能使青春之花 即便是凋谢也是壮丽的凋谢!</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">初来</h1><div class="post-meta">Nov 22, 2017<span> | </span><span class="category"><a href="/categories/linux/">linux</a></span></div><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-搭建开发环境"><span class="toc-number">1.</span> <span class="toc-text">1.搭建开发环境</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1安装TI-SDK"><span class="toc-number">1.1.</span> <span class="toc-text">1.1安装TI_SDK</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2编译内核"><span class="toc-number">1.2.</span> <span class="toc-text">1.2编译内核</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3烧写SD卡"><span class="toc-number">1.3.</span> <span class="toc-text">1.3烧写SD卡</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-简单的字符驱动"><span class="toc-number">2.</span> <span class="toc-text">2.简单的字符驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1驱动代码"><span class="toc-number">2.1.</span> <span class="toc-text">2.1驱动代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2测试代码-跑马灯"><span class="toc-number">2.2.</span> <span class="toc-text">2.2测试代码(跑马灯)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3关于printk调试"><span class="toc-number">2.3.</span> <span class="toc-text">2.3关于printk调试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-设备驱动模型驱动"><span class="toc-number">3.</span> <span class="toc-text">3.设备驱动模型驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1驱动代码"><span class="toc-number">3.1.</span> <span class="toc-text">3.1驱动代码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-设备树驱动"><span class="toc-number">4.</span> <span class="toc-text">4.设备树驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1初识设备树"><span class="toc-number">4.1.</span> <span class="toc-text">4.1初识设备树</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2修改AM437x设备树"><span class="toc-number">4.2.</span> <span class="toc-text">4.2修改AM437x设备树</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3驱动代码"><span class="toc-number">4.3.</span> <span class="toc-text">4.3驱动代码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-LED子系统驱动"><span class="toc-number">5.</span> <span class="toc-text">5.LED子系统驱动</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-心得"><span class="toc-number">6.</span> <span class="toc-text">6.心得</span></a></li></ol></div></div><div class="post-content"><p>本文主要记录AM437X驱动的LED。含简单的字符设备驱动、设备驱动模型、设备树以及LED子系统。<br><a id="more"></a></p>
<hr>
<p><strong>目前就Linux驱动的理解是：</strong></p>
<blockquote>
<p><strong>Linux驱动 = 裸机 + 框架</strong></p>
</blockquote>
<p><strong>关于框架，目前的理解是：</strong></p>
<blockquote>
<p>以LED驱动为例，之前印象中就是韦老大的思路，现在init里注册、硬件初始化，然后应用层open()、read()就调用了file_operations里面的drv_open()、drv_write()等，算是最简单的驱动框架。<br>然后韦老大又提及了总线设备驱动模型，将设备和驱动分离，感受到了新的框架。不久前，简单接触了下设备树，感觉就是总线设备驱动模型的修改（升级），将原来的设备部分，不再单独放在代码里，而是放在dts里面，开机加载，然后驱动匹配获取硬件资源。因此，感觉驱动的框架在一步一步的发展，优化，最原始的注册、open等框架，还是不变。<br>同时，了解到了除输入子系统的其它子系统，加深了对这一模式的理解。感觉就是，将某个硬件资源无缝的融入现有的环境中，而无须改变应用层的程序。</p>
</blockquote>
<p>这就是目前的一点小小理解吧，算是打开了个入口，希望以后了解得更加全面、细致。<br><img src="http://oo2opkb6t.bkt.clouddn.com/image/blog/170812/1.png" alt=""></p>
<h1 id="1-搭建开发环境"><a href="#1-搭建开发环境" class="headerlink" title="1.搭建开发环境"></a>1.搭建开发环境</h1><h2 id="1-1安装TI-SDK"><a href="#1-1安装TI-SDK" class="headerlink" title="1.1安装TI_SDK"></a>1.1安装TI_SDK</h2><p>先在TI官网下载<a href="http://software-dl.ti.com/sitara_linux/esd/processor-sdk/PROCESSOR-SDK-LINUX-AM437X/01_00_00_03/exports/ti-processor-sdk-linux-am437x-evm-01.00.00.03-Linux-x86-Install.bin" target="_blank" rel="noopener">ti-processor-sdk-linux-am437x-evm-01.00.00.03-Linux-x86-Install.bin</a><br>在Ubuntu（only Ubuntu 12.04 LTS and Ubuntu 14.04 LTS are supported）下，对该文件加入可执行权限，然后直接运行。安装目录选择默认即可。完成之后，便在当前用户的home目录生成了所有所需文件。<br><img src="http://oo2opkb6t.bkt.clouddn.com/image/blog/170812/2.png" alt=""></p>
<h2 id="1-2编译内核"><a href="#1-2编译内核" class="headerlink" title="1.2编译内核"></a>1.2编译内核</h2><p>在当前生成ti-processor-sdk-linux-am437x-evm-01.00.00.03目录下，有个Makefile，打开后可以看到相关的编译选项，如：</p>
<ul>
<li>编译全部文件：<code>make all</code></li>
<li>编译内核：<code>make linux</code></li>
<li>编译u-boot:<code>make u-boot-spl</code></li>
</ul>
<p>以及make的依赖：<code>-include Rules.make</code>。在本层目录里，打开<code>Rules.make</code>，可以知道内核的默认配置文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#defconfig</span><br><span class="line">DEFCONFIG=tisdk_am437x-evm_defconfig</span><br></pre></td></tr></table></figure></p>
<p>通过查找，tisdk_am437x-evm_defconfig在<code>~/ti-processor-sdk-linux-am437x-evm-01.00.00.03/board-support/linux-3.14.43+gitAUTOINC+875c69b2c3-g875c69b/arch/arm/configs</code>里。<br>这里通过修改该配置文件，然后重新编译内核，即可关闭系统LED相关的驱动，在后面自己写LED驱动时，防止互相干扰。<br>因此将tisdk_am437x-evm_defconfig配置文件里的所有有关LED的配置都关闭掉。</p>
<p>最后在顶层目录执行<code>make linux</code>,编译完成后，生成<code>~/ti-processor-sdk-linux-am437x-evm-01.00.00.03/board-support/linux-3.14.43+gitAUTOINC+875c69b2c3-g875c69b/arch/arm/boot/zImage</code>文件。</p>
<h2 id="1-3烧写SD卡"><a href="#1-3烧写SD卡" class="headerlink" title="1.3烧写SD卡"></a>1.3烧写SD卡</h2><p>回到<code>~/ti-processor-sdk-linux-am437x-evm-01.00.00.03/bin</code>下，TI制作了很多脚本，其中的<code>create-sdcard.sh</code>就是制作SD卡的。Ubuntu插上SD卡，然后切换成root用户，执行该脚本，根据提示一路选择下去即可。<br><img src="http://oo2opkb6t.bkt.clouddn.com/image/blog/170812/3.png" alt=""></p>
<p>这里烧写完了，测试发现并没有使用之前编译的内核，分析脚本后发现，该脚本直接使用的<code>~/ti-processor-sdk-linux-am437x-evm-01.00.00.03/filesystem</code>下的<code>tisdk-rootfs-image-am437x-evm.tar.gz</code>。脚本将该文件作为根文件系统放入SD卡，因此并没有使用之前编译的内核。解决方法要么在执行脚本的过程中根据提示输入相关的路径，要么在制作好SD卡后，将编译好的内核覆盖掉SD卡的内核即可。我选择的后者：<code>cp  ~/ti-processor-sdk-linux-am437x-evm-01.00.00.03/board-support/linux-3.14.43+gitAUTOINC+875c69b2c3-g875c69b/arch/arm/boot/zImage  /media/hceng/rootfs/boot/</code>。</p>
<p>最后将制作好的SD卡插上开发板启动即可。</p>
<h1 id="2-简单的字符驱动"><a href="#2-简单的字符驱动" class="headerlink" title="2.简单的字符驱动"></a>2.简单的字符驱动</h1><p>先记录下几个重要类型或结构体：</p>
<ul>
<li><p><strong>表示设备号</strong>(32位机中：高12位表示主设备号，低20位表示次设备号)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">typedef __kernel_dev_t	dev_t;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>描述字符设备</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">struct cdev &#123;</span><br><span class="line">	struct kobject kobj; //内嵌kobject结构体，用于设备驱动模型管理</span><br><span class="line">	struct module *owner; //包含指向该结构的模块的指针，用于引用计数</span><br><span class="line">	const struct file_operations *ops; //指向字符设备操作函数集的指针</span><br><span class="line">	struct list_head list; //该结构将使用该驱动的字符设备连接成一个链表</span><br><span class="line">	dev_t dev; //该字符设备的其实设备号，一个设备可能有多个设备号</span><br><span class="line">	unsigned int count; //使用该字符设备驱动的设备数量</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>描述类</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">struct class&#123;</span><br><span class="line">    const char *name; //类名称</span><br><span class="line">    struct module *owner; //对应模块</span><br><span class="line">    struct subsystem subsys; //对应的subsystem;</span><br><span class="line">    struct list_head children; //class_device链表</span><br><span class="line">    struct list_head  interfaces; //class_interface链表</span><br><span class="line">    struct semaphore  sem; /用于同步的信号锁</span><br><span class="line">    struct class_attribute *class_attrs; //类属性</span><br><span class="line">    int (*uevent)(struct class_device *dev,char **envp,int num_envp,</span><br><span class="line">                  char *buffer,int buffer_size); //事件</span><br><span class="line">    void (*release)(struct class_device *dev); //释放类设备</span><br><span class="line">    void (*class_release)(struct class *class); //释放类</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>总结下，目前理解的字符设备编写流程:</p>
<blockquote>
<p>1)驱动加载函数：<code>xx_drv_init()</code><br>　　1.1)申请设备号：<code>alloc_chrdev_region()</code><br>　　1.2)cde初始化(绑定fops)：<code>cdev_init()</code><br>　　1.3)注册到内核：<code>cdev_add()</code><br>　　1.4)创建类：<code>class_create()</code><br>　　1.5)向类中添加设备(mdev自动创建设备节点)：<code>device_create()</code><br>　　1.6)硬件相关(内存映射)：<code>ioremap()</code><br>2)驱动卸载函数：<code>xx_drv_exit()</code><br>　　2.1)移除设备：<code>device_destroy()</code><br>　　2.2)移除类：<code>class_destroy()</code><br>　　2.3)注销cdev：<code>cdev_del()</code><br>　　2.4)释放设备号：<code>unregister_chrdev()</code><br>　　2.5)释放内存：<code>iounmap()</code><br>3)必要修饰:<code>module_init(xx_drv_init);module_exit(xx_drv_exit);MODULE_LICENSE(&quot;GPL&quot;);</code><br>4)构造file_operations:<code>struct file_operations xx_drv_fops;</code><br>5)实现file_operations里每个函数:<code>xx_open()、xx_write()……</code></p>
</blockquote>
<h2 id="2-1驱动代码"><a href="#2-1驱动代码" class="headerlink" title="2.1驱动代码"></a>2.1驱动代码</h2><figure class="highlight c"><figcaption><span>[leds_drv.c]</span><a href="https://github.com/hceng/am437x/blob/master/drive/1th_led/v1.0/leds_drv.c" target="_blank" rel="noopener">link</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TI_LEDS_CNT     4</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> major;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">leds_cdev</span>;</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">class</span> *<span class="title">leds_cls</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> *PRCM_CM_PER_GPIO5_CLKCTRL = <span class="literal">NULL</span>;  </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> *CTRL_CONF_UART3_RXD = <span class="literal">NULL</span>;  </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> *CTRL_CONF_UART3_TXD = <span class="literal">NULL</span>;  </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> *CTRL_CONF_UART3_CTSN = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> *CTRL_CONF_UART3_RTSN = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> *GPIO_OE = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> *GPIO_SETDATAOUT = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> *GPIO_DATAOUT = <span class="literal">NULL</span>; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">leds_drv_open</span><span class="params">(struct inode *inode, struct file *file)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;    </span><br><span class="line">    <span class="keyword">int</span> minor = iminor(file-&gt;f_inode);</span><br><span class="line"></span><br><span class="line">    printk(KERN_INFO<span class="string">"%s OK.\n"</span>,__func__);</span><br><span class="line"></span><br><span class="line">    *PRCM_CM_PER_GPIO5_CLKCTRL  = (<span class="number">0x01</span>&lt;&lt;<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    *CTRL_CONF_UART3_RXD  &amp;= ~(<span class="number">0x7</span>&lt;&lt;<span class="number">0</span> | <span class="number">0x01</span>&lt;&lt;<span class="number">16</span> | <span class="number">0x01</span>&lt;&lt;<span class="number">17</span> | <span class="number">0x01</span>&lt;&lt;<span class="number">18</span>);</span><br><span class="line">    *CTRL_CONF_UART3_RXD  |=  (<span class="number">0x7</span>&lt;&lt;<span class="number">0</span> | <span class="number">0x01</span>&lt;&lt;<span class="number">17</span>);</span><br><span class="line"></span><br><span class="line">    *GPIO_OE              &amp;= ~(<span class="number">0x01</span>&lt;&lt;minor);</span><br><span class="line">    *GPIO_SETDATAOUT      |=  (<span class="number">0x01</span>&lt;&lt;minor);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;     </span><br><span class="line">&#125;   </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">leds_drv_write</span><span class="params">(struct file *file, <span class="keyword">const</span> <span class="keyword">char</span> __user *user_buf, <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span> * ppos)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">int</span>  minor = iminor(file-&gt;f_inode);</span><br><span class="line">    <span class="keyword">char</span> buf;  </span><br><span class="line"></span><br><span class="line">    printk(KERN_INFO<span class="string">"%s OK.\n"</span>,__func__);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(count != <span class="number">1</span>)&#123;</span><br><span class="line">        printk(KERN_INFO<span class="string">"write count != 1.\n"</span>); </span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(&amp;buf, user_buf, count))</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x01</span> == buf)  </span><br><span class="line">        *GPIO_DATAOUT |=  (<span class="number">0x01</span>&lt;&lt;minor);    </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="number">0x00</span> == buf)</span><br><span class="line">        *GPIO_DATAOUT &amp;= ~(<span class="number">0x01</span>&lt;&lt;minor);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">leds_fops</span> = &#123;</span></span><br><span class="line">    .owner  =   THIS_MODULE,  </span><br><span class="line">    .open   =   leds_drv_open,     </span><br><span class="line">    .write  =   leds_drv_write,	   </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">leds_drv_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//1.申请设备号</span></span><br><span class="line">    <span class="keyword">dev_t</span> devid;</span><br><span class="line"></span><br><span class="line">    printk(KERN_INFO<span class="string">"%s OK.\n"</span>,__func__);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(alloc_chrdev_region(&amp;devid, <span class="number">0</span>, TI_LEDS_CNT, <span class="string">"ti_leds"</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(KERN_INFO<span class="string">"%s ERROR.\n"</span>,__func__);</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    major = MAJOR(devid);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.注册到系统中</span></span><br><span class="line">    cdev_init(&amp;leds_cdev, &amp;leds_fops);        </span><br><span class="line">    cdev_add(&amp;leds_cdev, devid, TI_LEDS_CNT);   </span><br><span class="line"></span><br><span class="line">    leds_cls = class_create(THIS_MODULE, <span class="string">"ti_leds"</span>);</span><br><span class="line"></span><br><span class="line">    device_create(leds_cls, <span class="literal">NULL</span>, MKDEV(major, <span class="number">0</span>), <span class="literal">NULL</span>, <span class="string">"ti_led0"</span>); </span><br><span class="line">    device_create(leds_cls, <span class="literal">NULL</span>, MKDEV(major, <span class="number">1</span>), <span class="literal">NULL</span>, <span class="string">"ti_led1"</span>); </span><br><span class="line">    device_create(leds_cls, <span class="literal">NULL</span>, MKDEV(major, <span class="number">2</span>), <span class="literal">NULL</span>, <span class="string">"ti_led2"</span>); </span><br><span class="line">    device_create(leds_cls, <span class="literal">NULL</span>, MKDEV(major, <span class="number">3</span>), <span class="literal">NULL</span>, <span class="string">"ti_led3"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.硬件相关</span></span><br><span class="line">    PRCM_CM_PER_GPIO5_CLKCTRL = ioremap(<span class="number">0x44DF8800</span>+<span class="number">0x498</span>, <span class="number">0x04</span>*<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    CTRL_CONF_UART3_RXD       = ioremap(<span class="number">0x44E10000</span>+<span class="number">0xA28</span>, <span class="number">0x04</span>*<span class="number">4</span>);</span><br><span class="line">    CTRL_CONF_UART3_TXD       = CTRL_CONF_UART3_RXD + <span class="number">1</span>;</span><br><span class="line">    CTRL_CONF_UART3_CTSN      = CTRL_CONF_UART3_RXD + <span class="number">2</span>;</span><br><span class="line">    CTRL_CONF_UART3_RTSN      = CTRL_CONF_UART3_RXD + <span class="number">3</span>; </span><br><span class="line"></span><br><span class="line">    GPIO_OE                   = ioremap(<span class="number">0x48322000</span>+<span class="number">0x134</span>, <span class="number">0x04</span>); </span><br><span class="line">    GPIO_DATAOUT              = ioremap(<span class="number">0x48322000</span>+<span class="number">0x13C</span>, <span class="number">0x04</span>);</span><br><span class="line">    GPIO_SETDATAOUT           = ioremap(<span class="number">0x48322000</span>+<span class="number">0x194</span>, <span class="number">0x04</span>);</span><br><span class="line"></span><br><span class="line">error:</span><br><span class="line">    unregister_chrdev_region(MKDEV(major, <span class="number">0</span>), TI_LEDS_CNT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">leds_drv_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> i;</span><br><span class="line">    printk(KERN_INFO<span class="string">"%s OK.\n"</span>,__func__);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;TI_LEDS_CNT;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        device_destroy(leds_cls,  MKDEV(major, i));	</span><br><span class="line">    &#125;</span><br><span class="line">    class_destroy(leds_cls);</span><br><span class="line">    cdev_del(&amp;leds_cdev);</span><br><span class="line">    unregister_chrdev(major, <span class="string">"ti_leds"</span>); </span><br><span class="line"></span><br><span class="line">    iounmap(PRCM_CM_PER_GPIO5_CLKCTRL);</span><br><span class="line">    iounmap(CTRL_CONF_UART3_RXD);</span><br><span class="line">    iounmap(GPIO_OE);</span><br><span class="line">    iounmap(GPIO_DATAOUT);</span><br><span class="line">    iounmap(GPIO_SETDATAOUT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(leds_drv_init);</span><br><span class="line">module_exit(leds_drv_exit);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">"GPL"</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">"hceng &lt;huangcheng.job@foxmail.com&gt;"</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">"TI am437x board leds drvice"</span>);</span><br><span class="line">MODULE_ALIAS(<span class="string">"character device:ti_leds"</span>);</span><br><span class="line">MODULE_VERSION(<span class="string">"V1.0"</span>);</span><br></pre></td></tr></table></figure>
<h2 id="2-2测试代码-跑马灯"><a href="#2-2测试代码-跑马灯" class="headerlink" title="2.2测试代码(跑马灯)"></a>2.2测试代码(跑马灯)</h2><figure class="highlight c"><figcaption><span>[leds_app.c]</span><a href="https://github.com/hceng/am437x/blob/master/drive/1th_led/v1.0/leds_app.c" target="_blank" rel="noopener">link</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> msleep(x) usleep(x*1000)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd[<span class="number">4</span>];</span><br><span class="line">    <span class="keyword">int</span> val = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//const char *dev[] = &#123;"/dev/ti_led0", "/dev/ti_led1", "/dev/ti_led2", "/dev/ti_led3"&#125;;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *dev[] = &#123;<span class="string">"/dev/ti_led2"</span>, <span class="string">"/dev/ti_led0"</span>, <span class="string">"/dev/ti_led3"</span>, <span class="string">"/dev/ti_led1"</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">4</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        fd[i] = open(dev[i], O_RDWR);</span><br><span class="line">        <span class="keyword">if</span> (fd[i] &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"can't open %s\n"</span>, *dev[i]);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//leds off all.</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">4</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        write(fd[i], &amp;val, <span class="number">1</span>);</span><br><span class="line">    &#125;	</span><br><span class="line"></span><br><span class="line">    <span class="comment">//flicker leds.</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        val = !val;</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">4</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            write(fd[i], &amp;val, <span class="number">1</span>);</span><br><span class="line">            msleep(<span class="number">300</span>);</span><br><span class="line">        &#125;	</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-3关于printk调试"><a href="#2-3关于printk调试" class="headerlink" title="2.3关于printk调试"></a>2.3关于printk调试</h2><p>内核的printk定义了如下的打印等级：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#define KERN_EMERG        &quot;&lt;0&gt;&quot; /* system is unusable */</span><br><span class="line">#define KERN_ALERT        &quot;&lt;1&gt;&quot; /* action must be taken immediately */</span><br><span class="line">#define KERN_CRIT         &quot;&lt;2&gt;&quot; /* critical conditions */</span><br><span class="line">#define KERN_ERR          &quot;&lt;3&gt;&quot; /* error conditions */</span><br><span class="line">#define KERN_WARNING      &quot;&lt;4&gt;&quot; /* warning conditions */</span><br><span class="line">#define KERN_NOTICE       &quot;&lt;5&gt;&quot; /* normal but significant condition */</span><br><span class="line">#define KERN_INFO         &quot;&lt;6&gt;&quot; /* informational */</span><br><span class="line">#define KERN_DEBUG        &quot;&lt;7&gt;&quot; /* debug-level messages */</span><br></pre></td></tr></table></figure></p>
<ul>
<li>如果使用<strong>串口登陆</strong>，可通过修改/proc/sys/kernel/printk里的参数进行设置：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;8  4    1    7&quot; &gt;/proc/sys/kernel/printk</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>上面的四个数字分别代表：<br>控制台日志级别：优先级[s1] 高于该值的消息将被打印至控制台，[s1]数值越小，优先级越高；<br>默认的消息日志级别：将用该优先级来打印没有优先级的消息；<br>最低的控制台日志级别：控制台日志级别可被设置的最小值(最高优先级)；<br>默认的控制台日志级别：控制台日志级别的缺省值；</p>
<ul>
<li>如果使用<strong>SSH登陆</strong>，是无法显示printk的打印信息的，但打印的数据会被放在<code>/var/log/messages</code>和<code>/proc/kmsg</code>中，利用这一特性，可以后台运行tail命令进行侦测：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tail -f /var/log/messages &amp;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>缺点是不能设置打印等级，同时内核的其它信息也会被打印出来。</p>
<h1 id="3-设备驱动模型驱动"><a href="#3-设备驱动模型驱动" class="headerlink" title="3.设备驱动模型驱动"></a>3.设备驱动模型驱动</h1><p>关于<a href="http://localhost:4000/2017/03/18/%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E6%A8%A1%E5%9E%8B/" target="_blank" rel="noopener">设备驱动模型</a>前面以及有点了解，在写驱动的时候，主要体现在将原本的硬件资源信息抽取了出来，单独放在了一个文件里，当两个文件的分别加载的时候，根据名字匹配，匹配成功则调用probe()函数，进行类似前面的init()进行初始化。其它的内容基本一样，该干嘛就干嘛。</p>
<h2 id="3-1驱动代码"><a href="#3-1驱动代码" class="headerlink" title="3.1驱动代码"></a>3.1驱动代码</h2><figure class="highlight c"><figcaption><span>[leds_dev.c]</span><a href="https://github.com/hceng/am437x/blob/master/drive/1th_led/v2.0/leds_dev.c" target="_blank" rel="noopener">link</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/delay.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/irq.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/platform_device.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**************************************************</span></span><br><span class="line"><span class="comment">  TI_BOARD</span></span><br><span class="line"><span class="comment">  ---------------------------------------------------</span></span><br><span class="line"><span class="comment">  Ball     Color       Mode             Pin</span></span><br><span class="line"><span class="comment">  ---------------------------------------------------</span></span><br><span class="line"><span class="comment">  H24     D7_Blue      0x07     uart3_txd(GPIO5_3)</span></span><br><span class="line"><span class="comment">  H25     D8_Blue      0x07     uart3_rxd(GPIO5_2)</span></span><br><span class="line"><span class="comment">  K24     D9_Green     0x07     uart3_rtsn(GPIO5_1)</span></span><br><span class="line"><span class="comment">  H22     D10_Red      0x07     uart3_ctsn(GPIO5_0)</span></span><br><span class="line"><span class="comment"> **************************************************/</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">resource</span> <span class="title">leds_resource</span>[] = &#123;</span>  </span><br><span class="line"><span class="comment">//PRCM_CM_PER_GPIO5_CLKCTRL(498h)</span></span><br><span class="line">    [<span class="number">0</span>] = &#123;  </span><br><span class="line">        .start = <span class="number">0x44DF8800</span>,  </span><br><span class="line">        .end   = <span class="number">0x44DFFFFF</span>, </span><br><span class="line">        .name  = <span class="string">"CM_PER"</span>,</span><br><span class="line">        .flags = IORESOURCE_MEM,</span><br><span class="line">    &#125;,  </span><br><span class="line"></span><br><span class="line"><span class="comment">//CTRL_CONF_UART3_RXD(A28h)、CTRL_CONF_UART3_TXD(A2Ch)、CTRL_CONF_UART3_CTSN(A30h)、CTRL_CONF_UART3_RTSN((A34h))</span></span><br><span class="line">    [<span class="number">1</span>] = &#123;  </span><br><span class="line">        .start = <span class="number">0x44E10000</span>,  </span><br><span class="line">        .end   = <span class="number">0x44E1FFFF</span>, </span><br><span class="line">        .name  = <span class="string">"CONTROL_MODULE"</span>,</span><br><span class="line">        .flags = IORESOURCE_MEM,</span><br><span class="line">    &#125;,	</span><br><span class="line"><span class="comment">//GPIO_OE(134h)、GPIO_SETDATAOUT(194h)、GPIO_DATAOUT(13Ch)</span></span><br><span class="line">    [<span class="number">2</span>] = &#123; </span><br><span class="line">        .start = <span class="number">0x48322000</span>,  </span><br><span class="line">        .end   = <span class="number">0x48322FFF</span>, </span><br><span class="line">        .name  = <span class="string">"GOIP5"</span>,</span><br><span class="line">        .flags = IORESOURCE_MEM,</span><br><span class="line">    &#125;,</span><br><span class="line">    [<span class="number">3</span>] = &#123; </span><br><span class="line">        .start = <span class="number">0</span>,  </span><br><span class="line">        .end   = <span class="number">3</span>, </span><br><span class="line">        .name  = <span class="string">"GOIP5_PIN"</span>,</span><br><span class="line">        .flags = IORESOURCE_IO,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;;  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">leds_release</span><span class="params">(struct device * dev)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    printk(KERN_INFO<span class="string">"%s OK.\n"</span>,__func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_device</span> <span class="title">leds_dev</span> = &#123;</span></span><br><span class="line">    .name          = <span class="string">"ti_am437x_leds_platform"</span>,</span><br><span class="line">    .id       	   = <span class="number">-1</span>,  </span><br><span class="line">    .num_resources = ARRAY_SIZE(leds_resource),  </span><br><span class="line">    .resource      = leds_resource,  </span><br><span class="line">    .dev = &#123;   </span><br><span class="line">        .release = leds_release,   </span><br><span class="line">    &#125;, 	   </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">leds_dev_init</span><span class="params">(<span class="keyword">void</span>)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    printk(KERN_INFO<span class="string">"%s OK.\n"</span>,__func__);</span><br><span class="line">    <span class="keyword">return</span> platform_device_register(&amp;leds_dev);;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">leds_dev_exit</span><span class="params">(<span class="keyword">void</span>)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    printk(KERN_INFO<span class="string">"%s OK.\n"</span>,__func__);</span><br><span class="line">    platform_device_unregister(&amp;leds_dev);  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">module_init(leds_dev_init);</span><br><span class="line">module_exit(leds_dev_exit);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">"GPL"</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">"hceng &lt;huangcheng.job@foxmail.com&gt;"</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">"TI am437x board leds drvice"</span>);</span><br><span class="line">MODULE_ALIAS(<span class="string">"platform:ti_leds"</span>);</span><br><span class="line">MODULE_VERSION(<span class="string">"V2.0"</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><figcaption><span>[leds_drv.c]</span><a href="https://github.com/hceng/am437x/blob/master/drive/1th_led/v2.0/leds_drv.c" target="_blank" rel="noopener">link</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/version.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/interrupt.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/irq.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sched.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/pm.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sysctl.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/proc_fs.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/delay.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/platform_device.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/input.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/irq.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/uaccess.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/io.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TI_LEDS_CNT     4</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> major;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">leds_cdev</span>;</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">class</span> *<span class="title">leds_cls</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> *PRCM_CM_PER_GPIO5_CLKCTRL = <span class="literal">NULL</span>;  </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> *CTRL_CONF_UART3_RXD = <span class="literal">NULL</span>;  </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> *CTRL_CONF_UART3_TXD = <span class="literal">NULL</span>;  </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> *CTRL_CONF_UART3_CTSN = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> *CTRL_CONF_UART3_RTSN = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> *GPIO_OE = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> *GPIO_SETDATAOUT = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> *GPIO_DATAOUT = <span class="literal">NULL</span>;   </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">leds_drv_open</span><span class="params">(struct inode *inode, struct file *file)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;    </span><br><span class="line">    <span class="keyword">int</span> minor = iminor(file-&gt;f_inode);</span><br><span class="line"></span><br><span class="line">    printk(KERN_INFO<span class="string">"%s OK.\n"</span>,__func__);</span><br><span class="line"></span><br><span class="line">    *PRCM_CM_PER_GPIO5_CLKCTRL  = (<span class="number">0x01</span>&lt;&lt;<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    *CTRL_CONF_UART3_RXD  &amp;= ~(<span class="number">0x7</span>&lt;&lt;<span class="number">0</span> | <span class="number">0x01</span>&lt;&lt;<span class="number">16</span> | <span class="number">0x01</span>&lt;&lt;<span class="number">17</span> | <span class="number">0x01</span>&lt;&lt;<span class="number">18</span>);</span><br><span class="line">    *CTRL_CONF_UART3_RXD  |=  (<span class="number">0x7</span>&lt;&lt;<span class="number">0</span> | <span class="number">0x01</span>&lt;&lt;<span class="number">17</span>);</span><br><span class="line"></span><br><span class="line">    *GPIO_OE              &amp;= ~(<span class="number">0x01</span>&lt;&lt;minor);</span><br><span class="line">    *GPIO_SETDATAOUT      |=  (<span class="number">0x01</span>&lt;&lt;minor);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;     </span><br><span class="line">&#125;   </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">leds_drv_write</span><span class="params">(struct file *file, <span class="keyword">const</span> <span class="keyword">char</span> __user *user_buf, <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span> * ppos)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">int</span> minor = iminor(file-&gt;f_inode);</span><br><span class="line">    <span class="keyword">char</span> buf; </span><br><span class="line"></span><br><span class="line">    printk(KERN_INFO<span class="string">"%s OK.\n"</span>,__func__);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(count != <span class="number">1</span>)&#123;</span><br><span class="line">        printk(KERN_INFO<span class="string">"write count != 1.\n"</span>); </span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(&amp;buf, user_buf, count))</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x01</span> == buf)  </span><br><span class="line">        *GPIO_DATAOUT |=  (<span class="number">0x01</span>&lt;&lt;minor);    </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="number">0x00</span> == buf)</span><br><span class="line">        *GPIO_DATAOUT &amp;= ~(<span class="number">0x01</span>&lt;&lt;minor);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">leds_fops</span> = &#123;</span>  </span><br><span class="line">    .owner  =   THIS_MODULE,   </span><br><span class="line">    .open   =   leds_drv_open,       </span><br><span class="line">    .write  =   leds_drv_write,       </span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">leds_probe</span><span class="params">(struct platform_device *pdev)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">resource</span> *<span class="title">res</span>;</span>  </span><br><span class="line">    <span class="keyword">dev_t</span> devid;</span><br><span class="line"></span><br><span class="line">    printk(KERN_INFO<span class="string">"%s OK.\n"</span>,__func__);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.申请设备号</span></span><br><span class="line">    <span class="keyword">if</span>(alloc_chrdev_region(&amp;devid, <span class="number">0</span>, TI_LEDS_CNT, <span class="string">"ti_leds"</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(<span class="string">"%s ERROR\n"</span>,__func__);</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    major = MAJOR(devid);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.注册到系统中</span></span><br><span class="line">    cdev_init(&amp;leds_cdev, &amp;leds_fops);        </span><br><span class="line">    cdev_add(&amp;leds_cdev, devid, TI_LEDS_CNT);   </span><br><span class="line"></span><br><span class="line">    leds_cls = class_create(THIS_MODULE, <span class="string">"ti_leds"</span>);</span><br><span class="line"></span><br><span class="line">    device_create(leds_cls, <span class="literal">NULL</span>, MKDEV(major, <span class="number">0</span>), <span class="literal">NULL</span>, <span class="string">"ti_led0"</span>); </span><br><span class="line">    device_create(leds_cls, <span class="literal">NULL</span>, MKDEV(major, <span class="number">1</span>), <span class="literal">NULL</span>, <span class="string">"ti_led1"</span>); </span><br><span class="line">    device_create(leds_cls, <span class="literal">NULL</span>, MKDEV(major, <span class="number">2</span>), <span class="literal">NULL</span>, <span class="string">"ti_led2"</span>); </span><br><span class="line">    device_create(leds_cls, <span class="literal">NULL</span>, MKDEV(major, <span class="number">3</span>), <span class="literal">NULL</span>, <span class="string">"ti_led3"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.硬件相关</span></span><br><span class="line">    res = platform_get_resource_byname(pdev, IORESOURCE_MEM, <span class="string">"CM_PER"</span>);</span><br><span class="line">    <span class="keyword">if</span> (!res) </span><br><span class="line">        <span class="keyword">return</span> -EINVAL;	</span><br><span class="line">    PRCM_CM_PER_GPIO5_CLKCTRL = ioremap(res-&gt;start+<span class="number">0x498</span>, <span class="number">0x04</span>*<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    res = platform_get_resource_byname(pdev, IORESOURCE_MEM, <span class="string">"CONTROL_MODULE"</span>); </span><br><span class="line">    <span class="keyword">if</span> (!res) </span><br><span class="line">        <span class="keyword">return</span> -EINVAL;	</span><br><span class="line">    CTRL_CONF_UART3_RXD         = ioremap(res-&gt;start+<span class="number">0xA28</span>, <span class="number">0x04</span>*<span class="number">4</span>);</span><br><span class="line">    CTRL_CONF_UART3_TXD         = CTRL_CONF_UART3_RXD + <span class="number">1</span>;</span><br><span class="line">    CTRL_CONF_UART3_CTSN        = CTRL_CONF_UART3_RXD + <span class="number">2</span>;</span><br><span class="line">    CTRL_CONF_UART3_RTSN        = CTRL_CONF_UART3_RXD + <span class="number">3</span>; </span><br><span class="line"></span><br><span class="line">    res = platform_get_resource_byname(pdev, IORESOURCE_MEM, <span class="string">"GOIP5"</span>); </span><br><span class="line">    <span class="keyword">if</span> (!res) </span><br><span class="line">        <span class="keyword">return</span> -EINVAL;	</span><br><span class="line">    GPIO_OE                     = ioremap(res-&gt;start+<span class="number">0x134</span>, <span class="number">0x04</span>); </span><br><span class="line">    GPIO_DATAOUT                = ioremap(res-&gt;start+<span class="number">0x13C</span>, <span class="number">0x04</span>);</span><br><span class="line">    GPIO_SETDATAOUT             = ioremap(res-&gt;start+<span class="number">0x194</span>, <span class="number">0x04</span>);</span><br><span class="line"></span><br><span class="line">    *PRCM_CM_PER_GPIO5_CLKCTRL  = (<span class="number">0x01</span>&lt;&lt;<span class="number">1</span>);<span class="comment">//使能GPIO外设时钟</span></span><br><span class="line"></span><br><span class="line">error:</span><br><span class="line">    unregister_chrdev_region(MKDEV(major, <span class="number">0</span>), TI_LEDS_CNT);	</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">leds_remove</span><span class="params">(struct platform_device *pdev)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">unsigned</span> i;</span><br><span class="line">    printk(KERN_INFO<span class="string">"%s OK.\n"</span>,__func__);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;TI_LEDS_CNT;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        device_destroy(leds_cls,  MKDEV(major, i));	</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    class_destroy(leds_cls);</span><br><span class="line">    cdev_del(&amp;leds_cdev);</span><br><span class="line">    unregister_chrdev(major, <span class="string">"ti_leds"</span>); </span><br><span class="line"></span><br><span class="line">    iounmap(PRCM_CM_PER_GPIO5_CLKCTRL);</span><br><span class="line">    iounmap(CTRL_CONF_UART3_RXD);</span><br><span class="line">    iounmap(GPIO_OE);</span><br><span class="line">    iounmap(GPIO_DATAOUT);</span><br><span class="line">    iounmap(GPIO_SETDATAOUT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">leds_drv</span> = &#123;</span>  </span><br><span class="line">    .probe      = leds_probe,  </span><br><span class="line">    .remove     = leds_remove,  </span><br><span class="line">    .driver     = &#123;  </span><br><span class="line">        .name   = <span class="string">"ti_am437x_leds_platform"</span>,  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;;  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">leds_drv_init</span><span class="params">(<span class="keyword">void</span>)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    printk(KERN_INFO<span class="string">"%s OK.\n"</span>,__func__);</span><br><span class="line">    <span class="keyword">return</span> platform_driver_register(&amp;leds_drv);  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">leds_drv_exit</span><span class="params">(<span class="keyword">void</span>)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    printk(KERN_INFO<span class="string">"%s OK.\n"</span>,__func__);</span><br><span class="line">    platform_driver_unregister(&amp;leds_drv);  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">module_init(leds_drv_init);</span><br><span class="line">module_exit(leds_drv_exit);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">"GPL"</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">"hceng &lt;huangcheng.job@foxmail.com&gt;"</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">"TI am437x board leds drvice"</span>);</span><br><span class="line">MODULE_ALIAS(<span class="string">"platform:ti_leds"</span>);</span><br><span class="line">MODULE_VERSION(<span class="string">"V2.0"</span>);</span><br></pre></td></tr></table></figure>
<p>测试程序同前面的一样。</p>
<h1 id="4-设备树驱动"><a href="#4-设备树驱动" class="headerlink" title="4.设备树驱动"></a>4.设备树驱动</h1><h2 id="4-1初识设备树"><a href="#4-1初识设备树" class="headerlink" title="4.1初识设备树"></a>4.1初识设备树</h2><blockquote>
<p>1）前面的总线设备驱动模型中，硬件资源来自于leds_dev.c里面的信息，这样会导致不同的板子，会添加不同的硬件资源信息，造成内核的臃肿。<br>2）使用设备树后，内核不再包含硬件的描述，硬件描述放在单独的DTS里面，然后编译成二进制的DTB，在U-Boot启动的时候加载进去，然后内核进行解析。<br>3）DTS、DTC和DTB之间的关系：<br>DTS经过DTC编译得到DTB，DTB通过DTC反编译得到DTS.</p>
</blockquote>
<p><img src="http://oo2opkb6t.bkt.clouddn.com/image/blog/170812/4.png" alt=""></p>
<blockquote>
<p>4）ARM中，所有的DTS文件放在<code>arch/arm/boot/dts</code>目录中，为了简化，将Soc公用部分提取了出来作为dtsi，类似头文件。<br>5）DTC编译工具的源代码在scripts/dtc目录中，编译内核时，编译内核时，需要使能才能将源码编译成工具，对应于<code>scripts/dtc/Makefile</code>中<code>&quot;hostprogs-y:=dtc&quot;</code>。Ubuntu也可直接安装DTC工具：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install device-tree-compiler</span><br></pre></td></tr></table></figure></p>
<p>6)内核的<code>arch/arm/boot/dts/Makefile</code>中，描述了当某种Soc被选中后，哪些.dtb会编译出来。执行<code>make dtbs</code>，会根据<code>arch/arm/Makefile</code>编译指定目标。<br>7）单独编译与反编译：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./scripts/dtc/dtc -I dts -O dtb -o xxx.dtb arch/arm/boot/dts/xxx.dts   //dts-&gt;dtb</span><br><span class="line">./scripts/dtc/dtc -I dtb -O dts -o xxx.dts arch/arm/boot/dts/xxx.dtb   //dtb-&gt;dts</span><br></pre></td></tr></table></figure></p>
<p>8）后面认识深刻了，再总结总结。</p>
</blockquote>
<h2 id="4-2修改AM437x设备树"><a href="#4-2修改AM437x设备树" class="headerlink" title="4.2修改AM437x设备树"></a>4.2修改AM437x设备树</h2><p>AM437x的设备树文件在<code>~/ti-processor-sdk-linux-am437x-evm-01.00.00.03/board-support/linux-3.14.43+gitAUTOINC+875c69b2c3-g875c69b/arch/arm/boot/dts/</code>中，主要是<strong>am4372.dtsi</strong>和<strong>am437x-sk-evm.dts</strong>。我的目的是希望写个设备树框架的LED程序，因此想让am437x-sk-evm.dts干净点，只包含LED硬件描述，因此我需要删除am437x-sk-evm.dts里面的其它硬件描述。经过测试，am437x-sk-evm.dts里面包含部分MMC的描述，一旦删除将不能成功启动内核。而且，后面调试的时候，希望开发板通过NFS挂载的方式，直接加载编译的驱动模块，因此需要保留网卡描述部分。最后，将MMC和网卡必须的部分，提取了出来，放在了<a href="https://github.com/hceng/am437x/blob/master/drive/1th_led/v3.0/am4372.dtsi" target="_blank" rel="noopener">am4372.dtsi</a>中。精简后的am437x-sk-evm.dts内容如下：<br><figure class="highlight c"><figcaption><span>[am437x-sk-evm.dts]</span><a href="https://github.com/hceng/am437x/blob/master/drive/1th_led/v3.0/am437x-sk-evm.dts" target="_blank" rel="noopener">link</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* AM437x SK EVM */</span></span><br><span class="line"></span><br><span class="line">/dts-v1/;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"am4372.dtsi"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dt-bindings/pinctrl/am43xx.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dt-bindings/gpio/gpio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">/ &#123;</span><br><span class="line">	model = <span class="string">"TI AM437x SK EVM"</span>;</span><br><span class="line">	compatible = <span class="string">"ti,am437x-sk-evm"</span>,<span class="string">"ti,am4372"</span>,<span class="string">"ti,am43"</span>;</span><br><span class="line"></span><br><span class="line">    led_pin &#123;</span><br><span class="line">        compatible    = <span class="string">"ti_leds"</span>;</span><br><span class="line">        pinctrl-names = <span class="string">"default"</span>;</span><br><span class="line">        pinctrl<span class="number">-0</span> = &lt;&amp;leds_pins&gt;;</span><br><span class="line">        am437x,led_gpio0 = &lt;&amp;gpio5 <span class="number">0</span> GPIO_ACTIVE_HIGH&gt;;</span><br><span class="line">        am437x,led_gpio1 = &lt;&amp;gpio5 <span class="number">1</span> GPIO_ACTIVE_HIGH&gt;;</span><br><span class="line">        am437x,led_gpio2 = &lt;&amp;gpio5 <span class="number">2</span> GPIO_ACTIVE_HIGH&gt;;</span><br><span class="line">        am437x,led_gpio3 = &lt;&amp;gpio5 <span class="number">3</span> GPIO_ACTIVE_HIGH&gt;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&amp;am43xx_pinmux &#123;</span><br><span class="line">	</span><br><span class="line">	leds_pins: leds_pins &#123;</span><br><span class="line">		pinctrl-single,pins = &lt;</span><br><span class="line">			<span class="number">0x228</span> (PIN_OUTPUT | MUX_MODE7)	<span class="comment">/* uart3_rxd.gpio5_2 */</span></span><br><span class="line">			<span class="number">0x22c</span> (PIN_OUTPUT | MUX_MODE7)	<span class="comment">/* uart3_txd.gpio5_3 */</span></span><br><span class="line">			<span class="number">0x230</span> (PIN_OUTPUT | MUX_MODE7)	<span class="comment">/* uart3_ctsn.gpio5_0 */</span></span><br><span class="line">			<span class="number">0x234</span> (PIN_OUTPUT | MUX_MODE7)	<span class="comment">/* uart3_rtsn.gpio5_1 */</span></span><br><span class="line">		&gt;;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&amp;gpio5 &#123;</span><br><span class="line">	status = <span class="string">"okay"</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><br>额，在调试的过程中，需要不断编译新的DTB和复制到SD卡的rootfs分区中，仿照前面写了个<a href="https://github.com/hceng/am437x/blob/master/drive/1th_led/v3.0/hceng.sh" target="_blank" rel="noopener">脚本</a>进行自动编译和复制，同时检查文件的生成时间间隔，实际中，确实减少了焦躁的重复操作。</p>
<h2 id="4-3驱动代码"><a href="#4-3驱动代码" class="headerlink" title="4.3驱动代码"></a>4.3驱动代码</h2><figure class="highlight c"><figcaption><span>[leds_drv.c]</span><a href="https://github.com/hceng/am437x/blob/master/drive/1th_led/v3.0/leds_drv.c" target="_blank" rel="noopener">link</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/version.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/interrupt.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/irq.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sched.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/pm.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sysctl.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/proc_fs.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/delay.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/platform_device.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/input.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/irq.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/uaccess.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/io.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/of_gpio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TI_LEDS_CNT     4</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> major;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">leds_cdev</span>;</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">class</span> *<span class="title">leds_cls</span>;</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> led0,led1,led2,led3; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">leds_drv_open</span><span class="params">(struct inode *inode, struct file *file)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;    </span><br><span class="line">    printk(KERN_INFO<span class="string">"%s OK.\n"</span>,__func__); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;     </span><br><span class="line">&#125;   </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">leds_drv_write</span><span class="params">(struct file *file, <span class="keyword">const</span> <span class="keyword">char</span> __user *user_buf, <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span> * ppos)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">int</span> minor = iminor(file-&gt;f_inode); </span><br><span class="line">	<span class="keyword">char</span> buf;</span><br><span class="line">	</span><br><span class="line">    printk(KERN_INFO<span class="string">"%s OK.\n"</span>,__func__);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(count != <span class="number">1</span>)&#123;</span><br><span class="line">        printk(KERN_INFO<span class="string">"write count != 1.\n"</span>); </span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(&amp;buf, user_buf, count))</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">	</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">0x01</span> == buf)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">switch</span>(minor)&#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            gpio_set_value(led0, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            gpio_set_value(led1, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            gpio_set_value(led2, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            gpio_set_value(led3, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            printk(KERN_INFO<span class="string">"%s receive minor error.\n"</span>,__func__);</span><br><span class="line">        &#125;                       </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="number">0x00</span> == buf)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">switch</span>(minor)&#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            gpio_set_value(led0, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            gpio_set_value(led1, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            gpio_set_value(led2, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            gpio_set_value(led3, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            printk(KERN_INFO<span class="string">"%s receive minor error\n"</span>,__func__);</span><br><span class="line">        &#125;       </span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">leds_fops</span> = &#123;</span>  </span><br><span class="line">    .owner  =   THIS_MODULE,   </span><br><span class="line">    .open   =   leds_drv_open,       </span><br><span class="line">    .write  =   leds_drv_write,       </span><br><span class="line">&#125;; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">leds_probe</span><span class="params">(struct platform_device *pdev)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span> = &amp;<span class="title">pdev</span>-&gt;<span class="title">dev</span>;</span></span><br><span class="line">    <span class="keyword">dev_t</span> devid;</span><br><span class="line">	</span><br><span class="line">    printk(KERN_INFO<span class="string">"%s OK.\n"</span>,__func__);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.申请设备号</span></span><br><span class="line">    <span class="keyword">if</span>(alloc_chrdev_region(&amp;devid, <span class="number">0</span>, TI_LEDS_CNT, <span class="string">"ti_leds"</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(KERN_INFO<span class="string">"%s ERROR.\n"</span>,__func__);</span><br><span class="line">        <span class="keyword">goto</span> error;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    major = MAJOR(devid);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.注册到系统中</span></span><br><span class="line">    cdev_init(&amp;leds_cdev, &amp;leds_fops);        </span><br><span class="line">    cdev_add(&amp;leds_cdev, devid, TI_LEDS_CNT);   </span><br><span class="line"></span><br><span class="line">    leds_cls = class_create(THIS_MODULE, <span class="string">"ti_leds"</span>);</span><br><span class="line">	</span><br><span class="line">    device_create(leds_cls, <span class="literal">NULL</span>, MKDEV(major, <span class="number">0</span>), <span class="literal">NULL</span>, <span class="string">"ti_led0"</span>); </span><br><span class="line">    device_create(leds_cls, <span class="literal">NULL</span>, MKDEV(major, <span class="number">1</span>), <span class="literal">NULL</span>, <span class="string">"ti_led1"</span>); </span><br><span class="line">    device_create(leds_cls, <span class="literal">NULL</span>, MKDEV(major, <span class="number">2</span>), <span class="literal">NULL</span>, <span class="string">"ti_led2"</span>); </span><br><span class="line">    device_create(leds_cls, <span class="literal">NULL</span>, MKDEV(major, <span class="number">3</span>), <span class="literal">NULL</span>, <span class="string">"ti_led3"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.硬件相关</span></span><br><span class="line">    led0 = of_get_named_gpio(dev-&gt;of_node, <span class="string">"am437x,led_gpio0"</span>, <span class="number">0</span>);;</span><br><span class="line">    led1 = of_get_named_gpio(dev-&gt;of_node, <span class="string">"am437x,led_gpio1"</span>, <span class="number">0</span>);;</span><br><span class="line">    led2 = of_get_named_gpio(dev-&gt;of_node, <span class="string">"am437x,led_gpio2"</span>, <span class="number">0</span>);;</span><br><span class="line">    led3 = of_get_named_gpio(dev-&gt;of_node, <span class="string">"am437x,led_gpio3"</span>, <span class="number">0</span>);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//printk(KERN_INFO"led0 = %d\n",led0);</span></span><br><span class="line">    <span class="comment">//printk(KERN_INFO"led1 = %d\n",led1);</span></span><br><span class="line">    <span class="comment">//printk(KERN_INFO"led2 = %d\n",led2);</span></span><br><span class="line">    <span class="comment">//printk(KERN_INFO"led3 = %d\n",led3);</span></span><br><span class="line"></span><br><span class="line">    devm_gpio_request_one(dev, led0, GPIOF_OUT_INIT_HIGH, <span class="string">"LED0"</span>);</span><br><span class="line">    devm_gpio_request_one(dev, led1, GPIOF_OUT_INIT_HIGH, <span class="string">"LED1"</span>);</span><br><span class="line">    devm_gpio_request_one(dev, led2, GPIOF_OUT_INIT_HIGH, <span class="string">"LED2"</span>);</span><br><span class="line">    devm_gpio_request_one(dev, led3, GPIOF_OUT_INIT_HIGH, <span class="string">"LED3"</span>);</span><br><span class="line"></span><br><span class="line">error:</span><br><span class="line">    unregister_chrdev_region(MKDEV(major, <span class="number">0</span>), TI_LEDS_CNT);	</span><br><span class="line">	</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">leds_remove</span><span class="params">(struct platform_device *pdev)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">unsigned</span> i;</span><br><span class="line">    printk(KERN_INFO<span class="string">"%s OK.\n"</span>,__func__);</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;TI_LEDS_CNT;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        device_destroy(leds_cls,  MKDEV(major, i));	</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    class_destroy(leds_cls);</span><br><span class="line">    cdev_del(&amp;leds_cdev);</span><br><span class="line">    unregister_chrdev(major, <span class="string">"ti_leds"</span>); </span><br><span class="line">	</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">of_gpio_leds_match</span>[] = &#123;</span></span><br><span class="line">	&#123; .compatible = <span class="string">"ti_leds"</span>, &#125;,</span><br><span class="line">	&#123;&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">leds_drv</span> = &#123;</span></span><br><span class="line">	.probe		= leds_probe,</span><br><span class="line">	.remove		= leds_remove,</span><br><span class="line">	.driver		= &#123;</span><br><span class="line">		.name	= <span class="string">"ti_am437x_leds_platform"</span>,</span><br><span class="line">		.owner	= THIS_MODULE,</span><br><span class="line">		.of_match_table = of_match_ptr(of_gpio_leds_match),</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">leds_drv_init</span><span class="params">(<span class="keyword">void</span>)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    printk(KERN_INFO<span class="string">"%s OK.\n"</span>,__func__);</span><br><span class="line">    <span class="keyword">return</span> platform_driver_register(&amp;leds_drv);  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">leds_drv_exit</span><span class="params">(<span class="keyword">void</span>)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    printk(KERN_INFO<span class="string">"%s OK.\n"</span>,__func__);</span><br><span class="line">    platform_driver_unregister(&amp;leds_drv);  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">module_init(leds_drv_init);</span><br><span class="line">module_exit(leds_drv_exit);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">"GPL"</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">"hceng &lt;huangcheng.job@foxmail.com&gt;"</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">"TI am437x board leds drvice"</span>);</span><br><span class="line">MODULE_ALIAS(<span class="string">"platform:device tree:ti_leds"</span>);</span><br><span class="line">MODULE_VERSION(<span class="string">"V3.0"</span>);</span><br></pre></td></tr></table></figure>
<p>测试程序同前面的一样。</p>
<h1 id="5-LED子系统驱动"><a href="#5-LED子系统驱动" class="headerlink" title="5.LED子系统驱动"></a>5.LED子系统驱动</h1><p>留个挂念，以后再添加。</p>
<h1 id="6-心得"><a href="#6-心得" class="headerlink" title="6.心得"></a>6.心得</h1><p>在我理解到驱动=裸机+软件框架的时候，我对之前的裸机也就没那么排斥了。<br>而且这个软件框架，就现在来看，核心的那几步像：申请设备号、注册设备、创建类和创建节点这些都不变，早晚会做。<br>所以，我算入门了吗？😀<br>下一步，开始另一个阶段~</p>
</div><div class="tags"><a href="/tags/AM437X/">AM437X</a><a href="/tags/Linux驱动/">Linux驱动</a></div><div class="post-nav"><a href="/2017/11/22/new/" class="pre">new</a><a href="/2017/08/12/AM437x——LED驱动/" class="next">AM437x——LED驱动</a></div></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/AM437X/" style="font-size: 15px;">AM437X</a> <a href="/tags/Linux驱动/" style="font-size: 15px;">Linux驱动</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/11/22/new/">new</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/22/初来/">初来</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/12/AM437x——LED驱动/">AM437x——LED驱动</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://www.beibq.cn/book/rl3j968" title="linux嵌入式文档整理" target="_blank">linux嵌入式文档整理</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">li.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>